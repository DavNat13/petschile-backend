// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----------------------------------------
// Modelos de Localización (Región/Comuna)
// ----------------------------------------
model Region {
  id      Int      @id @default(autoincrement())
  nombre  String   @unique
  comunas Comuna[]
  users   User[]
}
model Comuna {
  id       Int    @id @default(autoincrement())
  nombre   String
  region   Region @relation(fields: [regionId], references: [id])
  regionId Int
  users    User[]
  @@unique([nombre, regionId])
}

// ----------------------------------------
// Modelos de Usuario y Autenticación
// ----------------------------------------
model Role {
  id     Int    @id @default(autoincrement())
  nombre String @unique // "CLIENT", "SELLER", "ADMIN"
  users  User[]
}
model User {
  id              String    @id @default(uuid())
  run             String    @unique
  email           String    @unique
  nombre          String
  apellidos       String
  password        String
  fechaNacimiento DateTime?
  direccion       String?
  role            Role      @relation(fields: [roleId], references: [id])
  roleId          Int
  region          Region?   @relation(fields: [regionId], references: [id])
  regionId        Int?
  comuna          Comuna?   @relation(fields: [comunaId], references: [id])
  comunaId        Int?
  // Relaciones
  orders    Order[]
  cart      Cart?
  auditLogs AuditLog[]
}

// ----------------------------------------
// Modelos de Productos y Catálogo
// ----------------------------------------
model Category {
  id       Int       @id @default(autoincrement())
  nombre   String    @unique
  products Product[]
}

model Brand {
  id        Int       @id @default(autoincrement())
  nombre    String    @unique
  // --- ¡MODIFICADO! ---
  // Ahora una marca tiene muchos productos
  products  Product[]
  // --- FIN ---
}

model Product {
  id            String   @id @default(uuid())
  codigo        String   @unique
  nombre        String
  descripcion   String?
  precio        Int
  precioOferta  Int?
  stock         Int      @default(0)
  stock_critico Int      @default(5)
  imagenes      String[]
  status        String   @default("ACTIVE") // "ACTIVE", "ARCHIVED"

  category   Category @relation(fields: [categoryId], references: [id])
  categoryId Int

  brand      Brand?   @relation(fields: [brandId], references: [id])
  brandId    Int?

  alimento  AttributeAlimento?
  juguete   AttributeJuguete?
  accesorio AttributeAccesorio?
  higiene   AttributeHigiene?
  orderItems OrderItem[]
  cartItems  CartItem[]
}

// --- Tablas de Atributos Específicos (3NF) ---
model AttributeAlimento {
  id           String  @id @default(uuid())
  medidaKg     Int?
  tipoAlimento String?
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId    String  @unique
}
model AttributeJuguete {
  id        String  @id @default(uuid())
  material  String?
  tamano    String?
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String  @unique
}
model AttributeAccesorio {
  id            String  @id @default(uuid())
  tipoAccesorio String?
  color         String?
  product       Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId     String  @unique
}
model AttributeHigiene {
  id            String  @id @default(uuid())
  contenidoNeto String?
  tipoMascota   String?
  product       Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String  @unique
}

// ----------------------------------------
// Modelos de Pedidos (Checkout)
// ----------------------------------------
model Order {
  id           String    @id @default(uuid())
  orderId      String    @unique // ej: "ORD-12345"
  orderDate    DateTime  @default(now())
  status       String    @default("Procesando")
  total        Int
  shippingCost Int
  shippingInfo Json
  user         User      @relation(fields: [userId], references: [id])
  userId       String
  items        OrderItem[]
}
model OrderItem {
  id              String  @id @default(uuid())
  quantity        Int
  priceAtPurchase Int
  order           Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId         String
  product         Product @relation(fields: [productId], references: [id])
  productId       String
  @@unique([orderId, productId])
}

// ----------------------------------------
// Modelos Autónomos (Blog, Contacto)
// ----------------------------------------
model BlogPost {
  id               String   @id @default(uuid())
  title            String
  shortDescription String
  longDescription  String
  image            String?
  author           String
  date             DateTime @default(now())
}
model ContactRequest {
  id      String   @id @default(uuid())
  fecha   DateTime @default(now())
  nombre  String
  email   String
  region  String
  comuna  String
  asunto  String
  mensaje String
  estado  String   @default("Pendiente")
}

// ----------------------------------------
// Modelo de Auditoría
// ----------------------------------------
model AuditLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())
  action    String   // Ej: "PRODUCT_CREATE", "USER_UPDATE", "ORDER_STATUS_CHANGE"
  entity    String   // Ej: "Product", "User", "Order"
  entityId  String   // El ID de la entidad afectada
  changes   Json?    // Opcional: JSON con { old: {...}, new: {...} }
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
}

// ----------------------------------------
// Modelo de Biblioteca de Medios
// ----------------------------------------
model MediaFile {
  id        String   @id @default(uuid())
  fileName  String
  url       String
  publicId  String   @unique
  fileType  String
  createdAt DateTime @default(now())
}

// ----------------------------------------
// Modelos de Carrito
// ----------------------------------------
model Cart {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique 
  items  CartItem[]
}
model CartItem {
  id        String  @id @default(uuid())
  quantity  Int     @default(1)
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartId    String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  @@unique([cartId, productId])
}