
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----------------------------------------
// Modelos de Localización (Región/Comuna)
// Normalizado de: RegisterPage, UserProfilePage, ContactPage
// ----------------------------------------

model Region {
  id      Int      @id @default(autoincrement())
  nombre  String   @unique
  // Relaciones
  comunas Comuna[]
  users   User[]
  // Nota: ContactRequest usa strings, lo cual está bien para un "log" de formulario.
}

model Comuna {
  id       Int    @id @default(autoincrement())
  nombre   String
  // Relación: Una comuna pertenece a una región
  region   Region @relation(fields: [regionId], references: [id])
  regionId Int
  // Relaciones
  users    User[]

  @@unique([nombre, regionId]) // Nombres de comunas se pueden repetir en distintas regiones
}

// ----------------------------------------
// Modelos de Usuario y Autenticación
// Normalizado de: RegisterPage, UserProfilePage, constants.js
// ----------------------------------------

model Role {
  id     Int    @id @default(autoincrement())
  nombre String @unique // "CLIENT", "SELLER", "ADMIN"
  // Relación
  users  User[]
}

model User {
  id              String    @id @default(uuid())
  run             String    @unique
  email           String    @unique
  nombre          String
  apellidos       String
  password        String // Se guardará hasheada
  fechaNacimiento DateTime?
  direccion       String?

  // Relación: Un usuario tiene un rol
  role     Role @relation(fields: [roleId], references: [id])
  roleId   Int // Clave foránea para Role

  // Relación: Un usuario tiene una localización (opcional)
  region   Region? @relation(fields: [regionId], references: [id])
  regionId Int?
  comuna   Comuna? @relation(fields: [comunaId], references: [id])
  comunaId Int?

  // Relación: Un usuario puede tener muchos pedidos
  orders   Order[]
}

// ----------------------------------------
// Modelos de Productos y Catálogo
// Normalizado de: ProductForm.jsx, ProductsPage.jsx
// ----------------------------------------

model Category {
  id       Int       @id @default(autoincrement())
  nombre   String    @unique // "Alimentos", "Juguetes", "Accesorios", "Higiene"
  // Relación
  products Product[]
}

model Brand {
  id       Int       @id @default(autoincrement())
  nombre   String    @unique // "Master Dog", "Pro Plan", etc.
  // Relación
  alimentos AttributeAlimento[]
}

model Product {
  id            String   @id @default(uuid())
  codigo        String   @unique
  nombre        String
  descripcion   String?
  precio        Int
  precioOferta  Int?
  stock         Int      @default(0)
  stock_critico Int      @default(5)
  imagenes      String[] // PostgreSQL soporta arrays de strings

  // Relación: Un producto pertenece a una categoría
  category   Category @relation(fields: [categoryId], references: [id])
  categoryId Int

  // Relaciones 1-a-1: Un producto solo tendrá *una* de estas relaciones
  alimento   AttributeAlimento?
  juguete    AttributeJuguete?
  accesorio  AttributeAccesorio?
  higiene    AttributeHigiene?

  // Relación: Un producto puede estar en muchos items de pedidos
  orderItems OrderItem[]
}

// --- Tablas de Atributos Específicos (3NF) ---

model AttributeAlimento {
  id           String  @id @default(uuid())
  medidaKg     Int?
  tipoAlimento String?

  // Relación 1-a-1: Este atributo pertenece a un producto
  product   Product @relation(fields: [productId], references: [id])
  productId String  @unique // @unique fuerza la relación 1-a-1

  // Relación: Un alimento tiene una marca
  brand     Brand? @relation(fields: [brandId], references: [id])
  brandId   Int?
}

model AttributeJuguete {
  id        String  @id @default(uuid())
  material  String?
  tamano    String?

  // Relación 1-a-1
  product   Product @relation(fields: [productId], references: [id])
  productId String  @unique
}

model AttributeAccesorio {
  id            String  @id @default(uuid())
  tipoAccesorio String?
  color         String?

  // Relación 1-a-1
  product   Product @relation(fields: [productId], references: [id])
  productId String  @unique
}

model AttributeHigiene {
  id            String  @id @default(uuid())
  contenidoNeto String?
  tipoMascota   String?

  // Relación 1-a-1
  product   Product @relation(fields: [productId], references: [id])
  productId String  @unique
}

// ----------------------------------------
// Modelos de Pedidos (Checkout)
// Normalizado de: CheckoutPage.jsx, OrdersManagementPage.jsx
// ----------------------------------------

model Order {
  id           String    @id @default(uuid())
  orderDate    DateTime  @default(now())
  status       String    @default("Procesando") // "Procesando", "Completado", "Cancelado"
  total        Int
  shippingCost Int
  shippingInfo Json // Guardar la info de envío (nombre, dirección) como un "snapshot" JSON es correcto

  // Relación: Un pedido pertenece a un usuario
  user     User   @relation(fields: [userId], references: [id])
  userId   String

  // Relación: Un pedido tiene muchos items
  items    OrderItem[]
}

model OrderItem {
  id              String @id @default(uuid())
  quantity        Int
  priceAtPurchase Int // Precio del producto al momento de la compra (incluyendo oferta)

  // Relación: Pertenece a un pedido
  order     Order  @relation(fields: [orderId], references: [id])
  orderId   String

  // Relación: Referencia a un producto
  product   Product @relation(fields: [productId], references: [id])
  productId String

  // Un producto solo puede estar una vez por pedido
  @@unique([orderId, productId])
}

// ----------------------------------------
// Modelos Autónomos (Blog, Contacto)
// ----------------------------------------

model BlogPost {
  id               String   @id @default(uuid())
  title            String
  shortDescription String
  longDescription  String
  image            String?
  author           String
  date             DateTime @default(now())
}

model ContactRequest {
  id      String   @id @default(uuid())
  fecha   DateTime @default(now())
  nombre  String
  email   String
  region  String // Está bien como String, es un registro, no un dato relacional
  comuna  String
  asunto  String
  mensaje String
  estado  String   @default("Pendiente") // "Pendiente", "Respondido", "Cerrado"
}